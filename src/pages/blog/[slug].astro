---
import BaseLayout from '../../layouts/BaseLayout.astro'
import { getGhostPostsFull, type GhostPostFull } from '../../data/ghost'

export async function getStaticPaths() {
  const posts = await getGhostPostsFull()
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post, allPosts: posts },
  }))
}

type Props = { post: GhostPostFull; allPosts: GhostPostFull[] }
const { post, allPosts } = Astro.props

// Related posts: same tag first, then recent, exclude self, max 3
const related = allPosts
  .filter((p) => p.slug !== post.slug)
  .sort((a, b) => {
    const aMatch = a.tags.some((t) => post.tags.includes(t)) ? 1 : 0
    const bMatch = b.tags.some((t) => post.tags.includes(t)) ? 1 : 0
    if (bMatch !== aMatch) return bMatch - aMatch
    return new Date(b.dateISO).getTime() - new Date(a.dateISO).getTime()
  })
  .slice(0, 3)
---

<BaseLayout title={`${post.title} — Amalfi Notes`} description={post.excerpt} image={post.image ?? undefined}>

  <!-- POST HEADER -->
  <div class="post-header">
    <span class="post-header__cat">{post.tag}</span>
    <h1 class="post-header__title">{post.title}</h1>
    <hr class="post-header__rule" />
    <div class="post-header__meta">
      <span>{post.author.name}</span>
      <span><i class="bi bi-calendar3"></i> {post.date}</span>
      {post.readingTime > 0 && <span><i class="bi bi-clock"></i> {post.readingTime} min read</span>}
    </div>
  </div>

  <!-- HERO IMAGE -->
  {post.image && (
    <div class="post-image">
      <img src={post.image} alt={post.title} loading="eager" decoding="async" />
    </div>
  )}

  <!-- ARTICLE BODY -->
  <article class="article">
    <div class="article__content">
      <Fragment set:html={post.html} />
    </div>

    <!-- AUTHOR BIO -->
    <div class="author-bio">
      {post.author.image && (
        <img class="author-bio__avatar" src={post.author.image} alt={post.author.name} />
      )}
      <div>
        <div class="author-bio__name">{post.author.name}</div>
        {post.author.bio && <p>{post.author.bio}</p>}
      </div>
    </div>

    <!-- RELATED POSTS -->
    {related.length > 0 && (
      <div class="related">
        <div class="related__label">Further reading</div>
        {related.map((r) => (
          <div class="related-item">
            <h3 class="related-item__title"><a href={r.href}>{r.title}</a></h3>
            <p class="related-item__excerpt">{r.excerpt}</p>
            <div class="related-item__meta">
              {r.date}{r.tag ? ` \u00b7 ${r.tag}` : ''}{r.readingTime ? ` \u00b7 ${r.readingTime} min` : ''}
            </div>
          </div>
        ))}
      </div>
    )}

    <!-- BACK LINK -->
    <div class="back-link">
      <a href="/blog"><i class="bi bi-arrow-left"></i> Back to all posts</a>
    </div>
  </article>

</BaseLayout>

<style>
  /* === POST HEADER === */
  .post-header {
    padding-top: calc(var(--header-space) + 3rem);
    max-width: 720px;
    margin: 0 auto;
    padding-left: 1.5rem;
    padding-right: 1.5rem;
    text-align: center;
    border-bottom: 1px solid var(--color-border);
    padding-bottom: 2rem;
  }

  .post-header__cat {
    font-family: var(--font-mono);
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.18em;
    color: var(--color-accent);
    margin-bottom: 1rem;
    display: block;
  }

  .post-header__title {
    font-size: clamp(2rem, 4.5vw, 3.2rem);
    line-height: 1.15;
    margin-bottom: 1.5rem;
  }

  .post-header__rule {
    width: 40px;
    height: 2px;
    background: var(--color-accent);
    border: none;
    margin: 0 auto 1.5rem;
  }

  .post-header__meta {
    font-family: var(--font-mono);
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--color-text-muted);
    display: flex;
    justify-content: center;
    gap: 1.5rem;
    flex-wrap: wrap;
  }

  .post-header__meta span {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
  }

  /* === HERO IMAGE === */
  .post-image {
    max-width: 900px;
    margin: 2.5rem auto;
    padding: 0 1.5rem;
  }

  .post-image img {
    width: 100%;
    border-radius: var(--radius-sm);
  }

  /* === ARTICLE BODY === */
  .article {
    max-width: 680px;
    margin: 0 auto;
    padding: 0 1.5rem 3rem;
    position: relative;
  }

  /* --- Ghost HTML content styling --- */
  .article__content {
    padding-top: 2rem;
  }

  .article__content :global(p) {
    font-size: 1.05rem;
    line-height: 1.8;
    color: var(--color-text-muted);
    margin-bottom: 1.5rem;
  }

  /* Drop cap on first paragraph */
  .article__content :global(> p:first-child::first-letter) {
    font-family: var(--font-display);
    float: left;
    font-size: 4.5rem;
    line-height: 0.8;
    padding-right: 0.6rem;
    padding-top: 0.1rem;
    color: var(--color-accent);
    font-weight: 700;
  }

  .article__content :global(h2) {
    font-family: var(--font-display);
    font-size: 1.7rem;
    margin-top: 3rem;
    margin-bottom: 1rem;
    color: var(--color-text);
    letter-spacing: -0.02em;
  }

  .article__content :global(h3) {
    font-family: var(--font-display);
    font-size: 1.3rem;
    margin-top: 2.5rem;
    margin-bottom: 0.8rem;
    color: var(--color-text);
    letter-spacing: -0.02em;
  }

  .article__content :global(a) {
    color: var(--color-accent);
    text-decoration: underline;
    text-underline-offset: 2px;
    text-decoration-thickness: 1px;
  }

  .article__content :global(a:hover) {
    color: var(--color-accent-2);
  }

  .article__content :global(strong) {
    color: var(--color-text);
    font-weight: 600;
  }

  .article__content :global(em) {
    font-style: italic;
  }

  /* Blockquote — styled as pull quote */
  .article__content :global(blockquote) {
    margin: 3rem 0;
    padding: 2.5rem 0;
    border-top: 1px solid var(--color-border);
    border-bottom: 1px solid var(--color-border);
    text-align: center;
    position: relative;
  }

  .article__content :global(blockquote::before) {
    content: '\201C';
    font-family: var(--font-display);
    font-size: 5rem;
    color: var(--color-accent);
    line-height: 1;
    display: block;
    margin-bottom: -1rem;
    opacity: 0.3;
  }

  .article__content :global(blockquote p) {
    font-family: var(--font-display);
    font-size: 1.4rem;
    font-style: italic;
    line-height: 1.5;
    color: var(--color-text);
    margin-bottom: 0;
  }

  /* Images inside content */
  .article__content :global(img) {
    max-width: 100%;
    border-radius: var(--radius-sm);
    margin: 2rem 0;
  }

  .article__content :global(figure) {
    margin: 2.5rem 0;
  }

  .article__content :global(figure img) {
    margin: 0;
    width: 100%;
  }

  .article__content :global(figcaption) {
    font-family: var(--font-mono);
    font-size: 0.7rem;
    color: var(--color-text-muted);
    text-align: center;
    margin-top: 0.6rem;
    letter-spacing: 0.04em;
  }

  /* Lists */
  .article__content :global(ul),
  .article__content :global(ol) {
    margin: 1.5rem 0;
    padding-left: 1.5rem;
  }

  .article__content :global(li) {
    font-size: 1.05rem;
    line-height: 1.8;
    color: var(--color-text-muted);
    margin-bottom: 0.5rem;
  }

  /* Code */
  .article__content :global(code) {
    font-family: var(--font-mono);
    font-size: 0.88rem;
    background: var(--color-surface);
    padding: 0.15rem 0.4rem;
    border-radius: 4px;
    color: var(--color-accent);
  }

  .article__content :global(pre) {
    background: var(--color-surface);
    border-radius: var(--radius-sm);
    padding: 1.5rem;
    margin: 2rem 0;
    overflow-x: auto;
    border: 1px solid var(--color-border);
  }

  .article__content :global(pre code) {
    background: none;
    padding: 0;
    font-size: 0.85rem;
    color: var(--color-text);
  }

  /* Horizontal rule */
  .article__content :global(hr) {
    border: none;
    border-top: 1px solid var(--color-border);
    margin: 3rem 0;
  }

  /* Tables */
  .article__content :global(table) {
    width: 100%;
    border-collapse: collapse;
    margin: 2rem 0;
    font-size: 0.9rem;
  }

  .article__content :global(th) {
    font-family: var(--font-mono);
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    text-align: left;
    padding: 0.6rem 0;
    border-bottom: 2px solid var(--color-border);
    color: var(--color-text);
    font-weight: 500;
  }

  .article__content :global(td) {
    padding: 0.6rem 0.5rem 0.6rem 0;
    border-bottom: 1px solid var(--color-border);
    color: var(--color-text-muted);
    vertical-align: top;
  }

  /* Footnote links from Ghost */
  .article__content :global(sup a) {
    font-family: var(--font-mono);
    font-size: 0.7rem;
    color: var(--color-accent);
    font-weight: 500;
  }

  /* Ghost bookmark cards */
  .article__content :global(.kg-bookmark-card) {
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    overflow: hidden;
    margin: 2rem 0;
  }

  .article__content :global(.kg-bookmark-container) {
    display: flex;
    text-decoration: none;
    color: var(--color-text);
  }

  .article__content :global(.kg-bookmark-content) {
    flex: 1;
    padding: 1.2rem;
  }

  .article__content :global(.kg-bookmark-title) {
    font-family: var(--font-display);
    font-size: 1rem;
    margin-bottom: 0.3rem;
    font-weight: 700;
  }

  .article__content :global(.kg-bookmark-description) {
    font-size: 0.85rem;
    color: var(--color-text-muted);
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .article__content :global(.kg-bookmark-thumbnail) {
    width: 160px;
    flex-shrink: 0;
  }

  .article__content :global(.kg-bookmark-thumbnail img) {
    width: 100%;
    height: 100%;
    object-fit: cover;
    margin: 0;
    border-radius: 0;
  }

  /* === Wide breakout for galleries and wide cards === */
  .article__content :global(.kg-width-wide) {
    width: min(85vw, 1080px);
    /* Center in viewport regardless of parent width.
       50% = half of parent content width (puts us at parent center).
       Subtract half of own width to center self at that same point.
       Parent is centered in viewport, so this centers in viewport. */
    margin-left: calc(50% - min(85vw, 1080px) / 2);
    margin-right: calc(50% - min(85vw, 1080px) / 2);
  }

  /* Ghost gallery cards */
  .article__content :global(.kg-gallery-card) {
    margin: 2.5rem 0;
  }

  .article__content :global(.kg-gallery-container) {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .article__content :global(.kg-gallery-row) {
    display: flex;
    gap: 6px;
    width: 100%;
  }

  .article__content :global(.kg-gallery-image) {
    flex: 1 1 0%;
    position: relative;
    overflow: hidden;
    cursor: zoom-in;
  }

  .article__content :global(.kg-gallery-image img) {
    width: 100%;
    height: 100%;
    object-fit: cover;
    margin: 0;
    border-radius: 0;
    transition: transform 0.3s ease;
  }

  .article__content :global(.kg-gallery-image:hover img) {
    transform: scale(1.03);
  }

  /* Ghost callout card */
  .article__content :global(.kg-callout-card) {
    background: var(--color-surface);
    border-left: 3px solid var(--color-accent);
    padding: 1rem 1.2rem;
    margin: 1.5rem 0;
    border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
  }

  .article__content :global(.kg-callout-text) {
    font-size: 0.9rem;
    line-height: 1.6;
  }

  .article__content :global(.kg-callout-text p) {
    margin-bottom: 0;
    font-size: 0.9rem;
  }

  /* Ghost toggle (accordion) card */
  .article__content :global(.kg-toggle-card) {
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    margin: 1.5rem 0;
    overflow: hidden;
  }

  .article__content :global(.kg-toggle-heading) {
    padding: 1rem 1.2rem;
    cursor: pointer;
    font-family: var(--font-display);
    font-weight: 700;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .article__content :global(.kg-toggle-content) {
    padding: 0 1.2rem 1rem;
  }

  /* === Ghost video card === */
  .article__content :global(.kg-video-card) {
    margin: 2.5rem 0;
    position: relative;
    background: #000;
    border-radius: var(--radius-sm);
    overflow: hidden;
  }

  .article__content :global(.kg-video-container) {
    position: relative;
    width: 100%;
  }

  .article__content :global(.kg-video-container video) {
    width: 100%;
    height: auto;
    display: block;
    margin: 0;
    border-radius: 0;
  }

  /* Large play button overlay */
  .article__content :global(.kg-video-overlay) {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 2;
    transition: opacity 0.25s ease;
  }

  .article__content :global(.kg-video-large-play-icon) {
    width: 72px;
    height: 72px;
    border-radius: 50%;
    background: rgba(0, 0, 0, 0.55);
    backdrop-filter: blur(8px);
    border: 2px solid rgba(255, 255, 255, 0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: transform 0.2s ease, background 0.2s ease;
    color: #fff;
    padding: 0;
  }

  .article__content :global(.kg-video-large-play-icon:hover) {
    transform: scale(1.1);
    background: rgba(255, 89, 0, 0.75);
  }

  .article__content :global(.kg-video-large-play-icon svg) {
    width: 24px;
    height: 24px;
    fill: #fff;
    margin-left: 3px;
  }

  /* Bottom player bar */
  .article__content :global(.kg-video-player-container) {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 3;
    background: linear-gradient(transparent, rgba(0, 0, 0, 0.7));
    padding: 2rem 1rem 0.8rem;
    opacity: 0;
    transition: opacity 0.25s ease;
  }

  .article__content :global(.kg-video-container:hover .kg-video-player-container) {
    opacity: 1;
  }

  .article__content :global(.kg-video-player) {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #fff;
    font-family: var(--font-mono);
    font-size: 0.72rem;
  }

  .article__content :global(.kg-video-play-icon),
  .article__content :global(.kg-video-pause-icon),
  .article__content :global(.kg-video-unmute-icon),
  .article__content :global(.kg-video-mute-icon) {
    background: none;
    border: none;
    cursor: pointer;
    padding: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .article__content :global(.kg-video-play-icon svg),
  .article__content :global(.kg-video-pause-icon svg),
  .article__content :global(.kg-video-unmute-icon svg),
  .article__content :global(.kg-video-mute-icon svg) {
    width: 18px;
    height: 18px;
    fill: #fff;
  }

  .article__content :global(.kg-video-hide) {
    display: none !important;
  }

  .article__content :global(.kg-video-current-time),
  .article__content :global(.kg-video-duration) {
    white-space: nowrap;
    color: rgba(255, 255, 255, 0.8);
  }

  .article__content :global(.kg-video-time) {
    color: rgba(255, 255, 255, 0.5);
  }

  /* Seek slider */
  .article__content :global(.kg-video-seek-slider) {
    flex: 1;
    -webkit-appearance: none;
    appearance: none;
    height: 4px;
    background: rgba(255, 255, 255, 0.25);
    border-radius: 2px;
    outline: none;
    cursor: pointer;
  }

  .article__content :global(.kg-video-seek-slider::-webkit-slider-thumb) {
    -webkit-appearance: none;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #fff;
    cursor: pointer;
  }

  .article__content :global(.kg-video-seek-slider::-moz-range-thumb) {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #fff;
    border: none;
    cursor: pointer;
  }

  /* Playback rate button */
  .article__content :global(.kg-video-playback-rate) {
    background: none;
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 4px;
    color: #fff;
    font-family: var(--font-mono);
    font-size: 0.65rem;
    padding: 2px 6px;
    cursor: pointer;
    flex-shrink: 0;
  }

  .article__content :global(.kg-video-playback-rate:hover) {
    border-color: #fff;
  }

  /* Volume slider */
  .article__content :global(.kg-video-volume-slider) {
    width: 60px;
    -webkit-appearance: none;
    appearance: none;
    height: 4px;
    background: rgba(255, 255, 255, 0.25);
    border-radius: 2px;
    outline: none;
    cursor: pointer;
    flex-shrink: 0;
  }

  .article__content :global(.kg-video-volume-slider::-webkit-slider-thumb) {
    -webkit-appearance: none;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: #fff;
    cursor: pointer;
  }

  .article__content :global(.kg-video-volume-slider::-moz-range-thumb) {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: #fff;
    border: none;
    cursor: pointer;
  }

  /* Ghost audio card */
  .article__content :global(.kg-audio-card) {
    margin: 2rem 0;
  }

  /* Iframes (YouTube, Vimeo embeds) */
  .article__content :global(iframe) {
    width: 100%;
    border: none;
    border-radius: var(--radius-sm);
    margin: 2rem 0;
    aspect-ratio: 16/9;
  }

  /* === AUTHOR BIO === */
  .author-bio {
    display: flex;
    gap: 1.5rem;
    align-items: flex-start;
    padding: 2rem 0;
    border-top: 3px double var(--color-border);
    border-bottom: 3px double var(--color-border);
    margin: 3rem 0;
  }

  .author-bio__avatar {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    object-fit: cover;
    flex-shrink: 0;
  }

  .author-bio__name {
    font-family: var(--font-display);
    font-size: 1rem;
    margin-bottom: 0.3rem;
    color: var(--color-text);
  }

  .author-bio p {
    font-size: 0.88rem;
    line-height: 1.6;
    color: var(--color-text-muted);
    margin-bottom: 0;
  }

  /* === RELATED === */
  .related {
    border-top: 1px solid var(--color-border);
    padding-top: 2.5rem;
    margin-top: 2rem;
  }

  .related__label {
    font-family: var(--font-mono);
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.18em;
    color: var(--color-text-muted);
    margin-bottom: 1.5rem;
  }

  .related-item {
    padding: 1.2rem 0;
    border-bottom: 1px solid var(--color-border);
  }

  .related-item:last-child {
    border-bottom: none;
  }

  .related-item__title {
    font-size: 1.1rem;
    line-height: 1.3;
    margin-bottom: 0.3rem;
  }

  .related-item__title a {
    color: var(--color-text);
    text-decoration: none;
  }

  .related-item__title a:hover {
    color: var(--color-accent);
    text-decoration: none;
  }

  .related-item__excerpt {
    font-size: 0.85rem;
    line-height: 1.5;
    color: var(--color-text-muted);
    margin-bottom: 0.3rem;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .related-item__meta {
    font-family: var(--font-mono);
    font-size: 0.6rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--color-text-muted);
  }

  /* === BACK LINK === */
  .back-link {
    padding: 2.5rem 0 4rem;
  }

  .back-link a {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 500;
    color: var(--color-accent);
    text-decoration: none;
  }

  .back-link a:hover {
    color: var(--color-accent-2);
  }

  /* === LIGHTBOX === */
  :global(.gallery-lightbox) {
    position: fixed;
    inset: 0;
    z-index: 9999;
    background: rgba(0, 0, 0, 0.92);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: zoom-out;
    opacity: 0;
    transition: opacity 0.25s ease;
    padding: 2rem;
  }

  :global(.gallery-lightbox.is-visible) {
    opacity: 1;
  }

  :global(.gallery-lightbox img) {
    max-width: 90vw;
    max-height: 90vh;
    object-fit: contain;
    border-radius: 4px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    transform: scale(0.95);
    transition: transform 0.25s ease;
    margin: 0;
  }

  :global(.gallery-lightbox.is-visible img) {
    transform: scale(1);
  }

  :global(.gallery-lightbox__close) {
    position: absolute;
    top: 1.5rem;
    right: 1.5rem;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.15);
    border: none;
    color: #fff;
    font-size: 1.4rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s ease;
  }

  :global(.gallery-lightbox__close:hover) {
    background: rgba(255, 255, 255, 0.3);
  }

  :global(.gallery-lightbox__nav) {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.12);
    border: none;
    color: #fff;
    font-size: 1.5rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s ease;
  }

  :global(.gallery-lightbox__nav:hover) {
    background: rgba(255, 255, 255, 0.25);
  }

  :global(.gallery-lightbox__prev) {
    left: 1rem;
  }

  :global(.gallery-lightbox__next) {
    right: 1rem;
  }

  :global(.gallery-lightbox__counter) {
    position: absolute;
    bottom: 1.5rem;
    left: 50%;
    transform: translateX(-50%);
    font-family: var(--font-mono);
    font-size: 0.75rem;
    color: rgba(255, 255, 255, 0.6);
    letter-spacing: 0.1em;
  }

  /* === RESPONSIVE === */
  @media (max-width: 640px) {
    .post-header__title {
      font-size: clamp(1.6rem, 8vw, 2.2rem);
    }

    .article__content :global(> p:first-child::first-letter) {
      font-size: 3.5rem;
    }

    .article__content :global(blockquote p) {
      font-size: 1.15rem;
    }

    .author-bio {
      flex-direction: column;
    }

    .article__content :global(.kg-bookmark-container) {
      flex-direction: column;
    }

    .article__content :global(.kg-bookmark-thumbnail) {
      width: 100%;
      height: 180px;
    }

    .article__content :global(.kg-width-wide) {
      width: calc(100vw - 1rem);
      margin-left: calc(50% - (100vw - 1rem) / 2);
      margin-right: calc(50% - (100vw - 1rem) / 2);
    }

    .article__content :global(.kg-video-large-play-icon) {
      width: 56px;
      height: 56px;
    }

    .article__content :global(.kg-video-player-container) {
      opacity: 1;
    }

    .article__content :global(.kg-video-volume-slider) {
      display: none;
    }

    :global(.gallery-lightbox__nav) {
      width: 36px;
      height: 36px;
      font-size: 1.1rem;
    }
  }
</style>

<script is:inline>
  // === Gallery Lightbox ===
  ;(function () {
    const galleryImages = document.querySelectorAll('.kg-gallery-image img')
    if (!galleryImages.length) return

    // Collect all gallery images as flat array
    const allImages = Array.from(galleryImages)
    let currentIndex = 0
    let lightbox = null

    function createLightbox() {
      lightbox = document.createElement('div')
      lightbox.className = 'gallery-lightbox'
      lightbox.innerHTML = `
        <button class="gallery-lightbox__close" aria-label="Close">&times;</button>
        <button class="gallery-lightbox__nav gallery-lightbox__prev" aria-label="Previous">&lsaquo;</button>
        <img src="" alt="" />
        <button class="gallery-lightbox__nav gallery-lightbox__next" aria-label="Next">&rsaquo;</button>
        <div class="gallery-lightbox__counter"></div>
      `
      document.body.appendChild(lightbox)

      const img = lightbox.querySelector('img')
      const counter = lightbox.querySelector('.gallery-lightbox__counter')
      const prev = lightbox.querySelector('.gallery-lightbox__prev')
      const next = lightbox.querySelector('.gallery-lightbox__next')
      const close = lightbox.querySelector('.gallery-lightbox__close')

      function show(index) {
        currentIndex = index
        const src = allImages[index].src
        // Try to get highest resolution from srcset
        const srcset = allImages[index].getAttribute('srcset')
        if (srcset) {
          const sources = srcset.split(',').map(s => s.trim().split(/\s+/))
          const best = sources.reduce((a, b) => {
            const aw = parseInt(a[1]) || 0
            const bw = parseInt(b[1]) || 0
            return bw > aw ? b : a
          })
          img.src = best[0]
        } else {
          img.src = src
        }
        img.alt = allImages[index].alt || ''
        counter.textContent = `${index + 1} / ${allImages.length}`
        prev.style.display = allImages.length > 1 ? '' : 'none'
        next.style.display = allImages.length > 1 ? '' : 'none'
      }

      function open(index) {
        show(index)
        lightbox.style.display = 'flex'
        requestAnimationFrame(() => {
          requestAnimationFrame(() => lightbox.classList.add('is-visible'))
        })
        document.body.style.overflow = 'hidden'
      }

      function closeLightbox() {
        lightbox.classList.remove('is-visible')
        setTimeout(() => {
          lightbox.style.display = 'none'
          document.body.style.overflow = ''
        }, 250)
      }

      close.addEventListener('click', (e) => { e.stopPropagation(); closeLightbox() })
      lightbox.addEventListener('click', (e) => { if (e.target === lightbox) closeLightbox() })
      prev.addEventListener('click', (e) => {
        e.stopPropagation()
        show((currentIndex - 1 + allImages.length) % allImages.length)
      })
      next.addEventListener('click', (e) => {
        e.stopPropagation()
        show((currentIndex + 1) % allImages.length)
      })

      document.addEventListener('keydown', (e) => {
        if (lightbox.style.display !== 'flex') return
        if (e.key === 'Escape') closeLightbox()
        if (e.key === 'ArrowLeft') show((currentIndex - 1 + allImages.length) % allImages.length)
        if (e.key === 'ArrowRight') show((currentIndex + 1) % allImages.length)
      })

      return open
    }

    let openFn = null
    allImages.forEach((img, i) => {
      img.closest('.kg-gallery-image').addEventListener('click', () => {
        if (!openFn) openFn = createLightbox()
        openFn(i)
      })
    })
  })()

  // === Ghost Video Player ===
  ;(function () {
    document.querySelectorAll('.kg-video-card').forEach((card) => {
      const video = card.querySelector('video')
      if (!video) return

      const overlay = card.querySelector('.kg-video-overlay')
      const playBtn = card.querySelector('.kg-video-play-icon')
      const pauseBtn = card.querySelector('.kg-video-pause-icon')
      const muteBtn = card.querySelector('.kg-video-mute-icon')
      const unmuteBtn = card.querySelector('.kg-video-unmute-icon')
      const seekSlider = card.querySelector('.kg-video-seek-slider')
      const volumeSlider = card.querySelector('.kg-video-volume-slider')
      const currentTimeEl = card.querySelector('.kg-video-current-time')
      const durationEl = card.querySelector('.kg-video-duration')
      const rateBtn = card.querySelector('.kg-video-playback-rate')

      function fmt(sec) {
        const m = Math.floor(sec / 60)
        const s = Math.floor(sec % 60)
        return m + ':' + String(s).padStart(2, '0')
      }

      function togglePlay() {
        if (video.paused) {
          video.play()
        } else {
          video.pause()
        }
      }

      function updatePlayState() {
        if (video.paused) {
          playBtn && playBtn.classList.remove('kg-video-hide')
          pauseBtn && pauseBtn.classList.add('kg-video-hide')
          overlay && (overlay.style.display = '')
        } else {
          playBtn && playBtn.classList.add('kg-video-hide')
          pauseBtn && pauseBtn.classList.remove('kg-video-hide')
          overlay && (overlay.style.display = 'none')
        }
      }

      overlay && overlay.addEventListener('click', togglePlay)
      playBtn && playBtn.addEventListener('click', togglePlay)
      pauseBtn && pauseBtn.addEventListener('click', togglePlay)

      video.addEventListener('play', updatePlayState)
      video.addEventListener('pause', updatePlayState)

      video.addEventListener('loadedmetadata', () => {
        if (durationEl) durationEl.textContent = fmt(video.duration)
      })

      video.addEventListener('timeupdate', () => {
        if (currentTimeEl) currentTimeEl.textContent = fmt(video.currentTime)
        if (seekSlider && video.duration) {
          seekSlider.value = (video.currentTime / video.duration) * 100
        }
      })

      seekSlider && seekSlider.addEventListener('input', () => {
        if (video.duration) {
          video.currentTime = (seekSlider.value / 100) * video.duration
        }
      })

      function updateMuteState() {
        if (video.muted) {
          muteBtn && muteBtn.classList.add('kg-video-hide')
          unmuteBtn && unmuteBtn.classList.remove('kg-video-hide')
        } else {
          muteBtn && muteBtn.classList.remove('kg-video-hide')
          unmuteBtn && unmuteBtn.classList.add('kg-video-hide')
        }
      }

      muteBtn && muteBtn.addEventListener('click', () => { video.muted = true; updateMuteState() })
      unmuteBtn && unmuteBtn.addEventListener('click', () => { video.muted = false; updateMuteState() })
      updateMuteState()

      volumeSlider && volumeSlider.addEventListener('input', () => {
        video.volume = volumeSlider.value / 100
        video.muted = video.volume === 0
        updateMuteState()
      })

      const rates = [1, 1.25, 1.5, 2]
      let rateIndex = 0
      rateBtn && rateBtn.addEventListener('click', () => {
        rateIndex = (rateIndex + 1) % rates.length
        video.playbackRate = rates[rateIndex]
        rateBtn.textContent = rates[rateIndex] + '×'
      })
    })
  })()
</script>
